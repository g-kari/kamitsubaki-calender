name: PR Screenshot Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  validate-screenshots:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check PR for screenshots
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          // Check if PR affects UI files
          const uiFiles = files.filter(file => 
            file.filename.endsWith('.html') || 
            file.filename.endsWith('.css') || 
            file.filename.includes('style') ||
            (file.filename.endsWith('.js') && file.patch && file.patch.includes('style'))
          );
          
          const prBody = pr.body || '';
          
          // Check for screenshot markers in PR description
          const hasBeforeSection = prBody.includes('### ä¿®æ­£å‰') || prBody.includes('### Before');
          const hasAfterSection = prBody.includes('### ä¿®æ­£å¾Œ') || prBody.includes('### After');
          const hasImages = prBody.includes('![') || prBody.includes('<img') || prBody.includes('https://') && prBody.includes('.png') || prBody.includes('.jpg') || prBody.includes('.jpeg') || prBody.includes('.gif');
          const hasAutomatedScreenshots = prBody.includes('è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ') || prBody.includes('Automated Screenshots');
          
          // Check for automated screenshot comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const hasAutomatedComment = comments.some(comment => 
            comment.body.includes('è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ') || 
            comment.body.includes('Automated Screenshots')
          );
          
          if (uiFiles.length > 0) {
            console.log(`Found ${uiFiles.length} UI-related file changes`);
            console.log('UI files:', uiFiles.map(f => f.filename).join(', '));
            
            if (!hasAfterSection && !hasImages && !hasAutomatedScreenshots && !hasAutomatedComment) {
              const comment = [
                '## ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒå¿…è¦ã§ã™ / Screenshots Required',
                '',
                'ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯UIã«å½±éŸ¿ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ãŒã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚',
                'This pull request modifies UI-related files but doesn\'t include required screenshots.',
                '',
                '### å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ« / Modified Files:',
                uiFiles.map(f => `- \`${f.filename}\``).join('\n'),
                '',
                '### å¿…è¦ãªå¯¾å¿œ / Required Action:',
                'PRã®èª¬æ˜ã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã‹ã€è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½ã‚’å¾…ã£ã¦ãã ã•ã„ï¼š',
                'Please add the following to your PR description or wait for the automated screenshots:',
                '',
                '1. **ä¿®æ­£å¾Œã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ / After Screenshot** (å¿…é ˆ / Required)',
                '2. ä¿®æ­£å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ / Before Screenshot (è©²å½“ã™ã‚‹å ´åˆ / If applicable)',
                '',
                '### è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ / Automated Screenshots:',
                'ğŸ¤– ã“ã®PRã§ã¯è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™ã€‚',
                'ğŸ¤– Automated screenshots are enabled for this PR.',
                'ã—ã°ã‚‰ãã™ã‚‹ã¨è‡ªå‹•ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒã‚³ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚',
                'Screenshots will be automatically added as a comment shortly.',
                '',
                'ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®è¿½åŠ æ–¹æ³• / How to add screenshots:',
                '1. ç”»åƒã‚’GitHubã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— / Drag & drop images to GitHub',
                '2. ç”Ÿæˆã•ã‚ŒãŸMarkdownãƒªãƒ³ã‚¯ã‚’PRèª¬æ˜ã«è²¼ã‚Šä»˜ã‘ / Paste the generated Markdown links in PR description',
                '',
                '---',
                'âš ï¸ ã“ã®ãƒã‚§ãƒƒã‚¯ã¯è‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚',
                'âš ï¸ This is an automated check.',
                'ğŸ“¸ è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ‰‹å‹•ã§ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¿½åŠ ã¯ä»»æ„ã§ã™ã€‚',
                'ğŸ“¸ Since automated screenshots are enabled, manual screenshot addition is optional.'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              
              core.setFailed('Screenshots required for UI changes - automated screenshots will be provided shortly');
            } else {
              console.log('âœ… Screenshots found (manual or automated)');
            }
          } else {
            console.log('âœ… No UI files modified, screenshot validation skipped');
          }