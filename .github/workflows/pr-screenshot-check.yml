name: PR Screenshot Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-screenshots:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check PR for screenshots
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          // Check if PR affects UI files
          const uiFiles = files.filter(file => 
            file.filename.endsWith('.html') || 
            file.filename.endsWith('.css') || 
            file.filename.includes('style') ||
            (file.filename.endsWith('.js') && file.patch && file.patch.includes('style'))
          );
          
          const prBody = pr.body || '';
          
          // Check for screenshot markers in PR description
          const hasBeforeSection = prBody.includes('### ä¿®æ­£å‰') || prBody.includes('### Before');
          const hasAfterSection = prBody.includes('### ä¿®æ­£å¾Œ') || prBody.includes('### After');
          const hasImages = prBody.includes('![') || prBody.includes('<img') || prBody.includes('https://') && prBody.includes('.png') || prBody.includes('.jpg') || prBody.includes('.jpeg') || prBody.includes('.gif');
          
          if (uiFiles.length > 0) {
            console.log(`Found ${uiFiles.length} UI-related file changes`);
            console.log('UI files:', uiFiles.map(f => f.filename).join(', '));
            
            if (!hasAfterSection || !hasImages) {
              const comment = [
                '## ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒå¿…è¦ã§ã™ / Screenshots Required',
                '',
                'ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯UIã«å½±éŸ¿ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ãŒã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚',
                'This pull request modifies UI-related files but doesn\'t include required screenshots.',
                '',
                '### å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ« / Modified Files:',
                uiFiles.map(f => `- \`${f.filename}\``).join('\n'),
                '',
                '### å¿…è¦ãªå¯¾å¿œ / Required Action:',
                'PRã®èª¬æ˜ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ / Please add the following to your PR description:',
                '',
                '1. **ä¿®æ­£å¾Œã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ / After Screenshot** (å¿…é ˆ / Required)',
                '2. ä¿®æ­£å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ / Before Screenshot (è©²å½“ã™ã‚‹å ´åˆ / If applicable)',
                '',
                'ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®è¿½åŠ æ–¹æ³• / How to add screenshots:',
                '1. ç”»åƒã‚’GitHubã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— / Drag & drop images to GitHub',
                '2. ç”Ÿæˆã•ã‚ŒãŸMarkdownãƒªãƒ³ã‚¯ã‚’PRèª¬æ˜ã«è²¼ã‚Šä»˜ã‘ / Paste the generated Markdown links in PR description',
                '',
                '---',
                'âš ï¸ ã“ã®ãƒã‚§ãƒƒã‚¯ã¯è‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’è¿½åŠ å¾Œã€PRã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚',
                'This is an automated check. Please update the PR after adding screenshots.'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              
              core.setFailed('Screenshots required for UI changes');
            } else {
              console.log('âœ… Screenshots appear to be included');
            }
          } else {
            console.log('âœ… No UI files modified, screenshot validation skipped');
          }